---
title: "R Notebook"
output: html_notebook
---

### _Running if libraries are missing..._
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
# install.packages("Hmisc")
# install.packages("party")
# install.packages("MLmetrics")
# install.packages("gridExtra")
```


# load packages
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
library(randomForest)
library(Hmisc)
library(party)
library(caret)
library(MLmetrics)
library(gridExtra)
```

# Load the data
```{r}
data <- read_csv(file = "creditcard.csv") 
head(data)
```

# Describe data
```{r}
str(data)
```


# checking missing values
```{r}
nrow(data[is.na(data$Time)|is.na(data$Class),])
```

# make Class a factor
```{r}
data$Class <- factor(data$Class)
```

# Showing the fraud/non fraud cases through Class(0=non fraud, 1= fraud)

```{r}
ggplot(data = data, aes(x = factor(Class), 
                      y = prop.table(stat(count)), fill = factor(Class),
                      label = scales::percent(prop.table(stat(count))))) +
  geom_bar(position = "dodge") +  
  geom_text(stat = 'count',
            position = position_dodge(.9), 
            vjust = -0.5, 
            size = 3) + 
  scale_x_discrete(labels = c("no fraud", "fraud"))+
  scale_y_continuous(labels = scales::percent)+
  labs(x = 'Class', y = 'Percentage') +
  ggtitle("Distribution of class labels") +
  theme_light() 
```
  
# Distribution of variable 'Time' by class
```{r}
data %>%
  ggplot(aes(x = Time, fill = factor(Class))) + geom_histogram(bins = 100)+
  labs(x = 'Time in seconds since first transaction', y = 'No. of transactions') +
  ggtitle('Distribution of time of transaction by class') +
  facet_grid(Class ~ ., scales = 'free_y') + theme_light()
```


  
# Distirbution of transactions by class
```{r}
ggplot(data, aes(x = factor(Class), y = Amount)) + geom_boxplot() + 
  labs(x = 'Class', y = 'Amount') +
  ggtitle("Distribution of transaction amount by class") + theme_light()
```


# Observing how the class is affected by the amount of each variable
```{r}
p1=ggplot(data) +
aes(x = V1, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p2=ggplot(data) +
aes(x = V2, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p3=ggplot(data) +
aes(x = V3, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p4=ggplot(data) +
aes(x = V4, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p5=ggplot(data) +
aes(x = V5, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()  
p6=ggplot(data) +
aes(x = V6, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p7=ggplot(data) +
aes(x = V7, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p8=ggplot(data) +
aes(x = V8, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p9=ggplot(data) +
aes(x = V9, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p10=ggplot(data) +
aes(x = V10, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()  
p11=ggplot(data) +
aes(x = V11, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p12=ggplot(data) +
aes(x = V12, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p13=ggplot(data) +
aes(x = V13, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p14=ggplot(data) +
aes(x = V14, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p15=ggplot(data) +
aes(x = V15, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p16=ggplot(data) +
aes(x = V16, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()  
p17=ggplot(data) +
aes(x = V17, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p18=ggplot(data) +
aes(x = V18, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p19=ggplot(data) +
aes(x = V19, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p20=ggplot(data) +
aes(x = V20, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p21=ggplot(data) +
aes(x = V21, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p22=ggplot(data) +
aes(x = V22, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p23=ggplot(data) +
aes(x = V23, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p24=ggplot(data) +
aes(x = V24, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p25=ggplot(data) +
aes(x = V25, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p26=ggplot(data) +
aes(x = V26, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p27=ggplot(data) +
aes(x = V27, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
p28=ggplot(data) +
aes(x = V28, y = Amount, colour = Class) +
geom_point(shape = "circle", size = 1.5) +
scale_color_hue(direction = 1) +
theme_minimal()
```

# Now we can either call them 1 by 1 writing p1, p2 etc, or see them all together in same screen
```{r}
grid.arrange(p1,p2,p3,p4)
#,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20,p21,p22,p23,p24,p25,p26,p27,p28)
```

# We can observer here the graphs for variable 5, 13, 21 and 28
```{r}
grid.arrange(p5,p13,p21,p28)
```

# splitting the data
```{r}
intrain <- createDataPartition(y = data$Class, p = 0.8, list = FALSE)
train <- data[intrain, ]
test <- data[-intrain, ]
```


```{r}
train %>%
  select(Class) %>%
  group_by(Class) %>%
  summarise(count = n()) %>%
  glimpse
```

```{r}
test %>%
  select(Class) %>%
  group_by(Class) %>%
  summarise(count = n()) %>%
  glimpse
```
  
# build random forest model using every variable
```{r}
rfModel <- randomForest(Class ~ . , data = train)

test$predicted <- predict(rfModel, test)
```




```{r}
confusionMatrix(test$Class, test$predicted)
```


```{r}
F1_all <- F1_Score(test$Class, test$predicted)
F1_all
```


```{r}
options(repr.plot.width=5, repr.plot.height=4)
varImpPlot(rfModel,
          sort = T,
           n.var=10,
           main="Top 10 Most Important Variables")
```

# top predictive variables
```{r}
rfModelTrim1 <- randomForest(Class ~  V17, 
                            data = train)

test$predictedTrim1 <- predict(rfModelTrim1, test)
```


```{r}
F1_1 <- F1_Score(test$Class, test$predictedTrim1)
F1_1
```


# two variables
```{r}
rfModelTrim2 <- randomForest(Class ~  V17 + V12, 
                            data = train)

test$predictedTrim2 <- predict(rfModelTrim2, test)

F1_2 <- F1_Score(test$Class, test$predictedTrim2)
F1_2
```




# three variables
```{r}

rfModelTrim3 <- randomForest(Class ~  V17 + V12 + V14, 
                            data = train)

test$predictedTrim3 <- predict(rfModelTrim3, test)

F1_3 <- F1_Score(test$Class, test$predictedTrim3)
F1_3
```


# four variables
```{r}
rfModelTrim4 <- randomForest(Class ~  V17 + V12 + V14 + V10, 
                            data = train)

test$predictedTrim4 <- predict(rfModelTrim4, test)

F1_4 <- F1_Score(test$Class, test$predictedTrim4)
F1_4
```



# five variables
```{r}
rfModelTrim5 <- randomForest(Class ~  V17 + V12 + V14 + V10 + V16, 
                            data = train)

test$predictedTrim5 <- predict(rfModelTrim5, test)

F1_5 <- F1_Score(test$Class, test$predictedTrim5)
F1_5
```


# ten variables
```{r}
rfModelTrim10 <- randomForest(Class ~  V17 + V12 + V14 + V10 + V16 
                              + V11 + V9 + V4 + V18 + V26, 
                            data = train)

test$predictedTrim10 <- predict(rfModelTrim10, test)

F1_10 <- F1_Score(test$Class, test$predictedTrim10)
F1_10
```


# build dataframe of number of variables and scores
```{r}
numVariables <- c(1,2,3,4,5,10,17)
F1_Score <- c(F1_1, F1_2, F1_3, F1_4, F1_5, F1_10, F1_all)
variablePerf <- data.frame(numVariables, F1_Score)
```

# plot score performance against number of variables

```{r}
options(repr.plot.width=4, repr.plot.height=3)
ggplot(variablePerf, aes(numVariables, F1_Score)) + geom_point() + labs(x = "Number of Variables", y = "F1 Score", title = "F1 Score Performance")
```


```{r}
rf10 = randomForest(Class ~  V17 + V12 + V14 + V10 + V16 
                              + V11 + V9 + V4 + V18 + V26,  
                   ntree = 500,
                   data = train)
                   
options(repr.plot.width=6, repr.plot.height=4)
plot(rf10)
```


```{r}
options(repr.plot.width=6, repr.plot.height=4)
plot(rf10, xlim=c(0,100))
```















